<html>
<head>
    <script type="text/javascript" src="Test/Builder.js"></script>
    <script type="text/javascript" src="Test/More.js"></script>
    <script type="text/javascript" src="../MochiKit/Base.js"></script>
    <script type="text/javascript" src="../MochiKit/Iter.js"></script>
    <script type="text/javascript" src="../MochiKit/DOM.js"></script>
</head>
<body>

<pre id="test">
<script type="text/javascript">
try {
        
    // Counting the number of tests is really lame
    plan({'tests': 26});

    lst = [];
    o = {"blah": function () { lst.push("original"); }};
    addToCallStack(o, "blah", function () { lst.push("new"); }, true);
    addToCallStack(o, "blah", function () { lst.push("stuff"); }, true);
    is( typeof(o.blah), 'function', 'addToCallStack has a function' );
    is( o.blah.callStack.length, 3, 'callStack length 3' );
    o.blah();
    is( lst.join(" "), "original new stuff", "callStack in correct order" );
    is( o.blah, null, "set to null" );
    lst = [];
    o = {"blah": function () { lst.push("original"); }};
    addToCallStack(o, "blah",
        function () { lst.push("new"); return false;}, false);
    addToCallStack(o, "blah", function () { lst.push("stuff"); }, false);
    o.blah();
    is( lst.join(" "), "original new", "callStack in correct order (abort)" );
    o.blah();
    is( lst.join(" "), "original new original new", "callStack in correct order (again)" );
    
    
    is( escapeHTML("<>'\"&bar"), "&lt;&gt;&apos;&quot;&amp;bar", "escapeHTML" ); // for emacs highlighting: "

    var isDOM = function (value, expected, message) {
        is( escapeHTML(toHTML(value)), escapeHTML(expected), message );
    }

    var d = createDOM("span");
    isDOM( d, "<span/>", "createDOM empty" );


    d = createDOM("span", {"foo": "bar", "baz": "wibble"});
    isDOM( d, '<span baz="wibble" foo="bar"/>', "createDOM attributes" );

    d = createDOM("span", {"foo": "bar", "baz": "wibble"}, "one", "two", "three");
    toHTML(d);

    isDOM( d, '<span baz="wibble" foo="bar">onetwothree</span>', "createDOM contents" );

    var d = {"taco": "pork"};
    registerDOMConverter("taco",
        function (o) { return !isUndefinedOrNull(o.taco); },
        function (o) { return "Goddamn, I like " + o.taco + " tacos"; }
    );
    d = createDOM("span", null, d);
    // not yet public API
    MochiKit.DOM.domConverters.unregister("taco");

    isDOM( d, "<span>Goddamn, I like pork tacos</span>", "createDOM with custom converter" );
    
    is(
        escapeHTML(toHTML(SPAN(null))),
        escapeHTML(toHTML(createDOM("span", null))),
        "createDOMFunc vs createDOM"
    );

    is( scrapeText(d).join(""), "Goddamn, I like pork tacos", "scrape OK" );

    ok( !isUndefinedOrNull(getElement("test")), "getElement might work" );
    ok( !isUndefinedOrNull($("test")), "$alias$$ CASH MONEY alias might work" );

    d = createDOM("span", null, "one", "two");
    swapDOM(d.childNodes[0], document.createTextNode("uno"));
    isDOM( d, "<span>unotwo</span>", "swapDOM" );

    is( scrapeText(d).join(" "), "uno two", "multi-node scrapeText" );
    /*

        TODO:
            addLoadEvent
            setElementClass
            toggleElementClass
            addElementClass
            removeElementClass
            swapElementClass

    */

    d = createDOM("span", {"class": "foo"});
    MochiKit.DOM.setElementClass(d, "bar baz");
    ok( d.className == "bar baz", "setElementClass");
    MochiKit.DOM.toggleElementClass("bar", d);
    ok( d.className == "baz", "toggleElementClass: " + d.className);
    MochiKit.DOM.toggleElementClass("bar", d);
    ok( MochiKit.DOM.hasElementClass(d, "baz", "bar"), 
        "toggleElementClass 2: " + d.className);
    MochiKit.DOM.addElementClass(d, "bar");
    ok( MochiKit.DOM.hasElementClass(d, "baz", "bar"), 
        "toggleElementClass 3: " + d.className);
    ok( MochiKit.DOM.addElementClass(d, "blah"), "addElementClass return");
    ok( MochiKit.DOM.hasElementClass(d, "baz", "bar", "blah"), "addElementClass action");
    ok( ! MochiKit.DOM.hasElementClass(d, "not"), "hasElementClass single");
    ok( ! MochiKit.DOM.hasElementClass(d, "baz", "not"), "hasElementClass multiple");

    ok( true, "test suite finished!");
    
} catch (err) {
    
    var s = "test suite failure!\n";
    var o = {};
    var k = null;
    for (k in err) {
        // ensure unique keys?!
        if (!o[k]) {
            s +=  k + ": " + err[k] + "\n";
            o[k] = err[k];
        }
    }
    ok ( false, s );

}
</script>
</pre>
</body>
</html>
